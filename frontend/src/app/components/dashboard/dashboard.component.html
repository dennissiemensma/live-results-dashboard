<div class="d-flex flex-column min-vh-100">
  <!-- ===== TOP BAR ===== -->
  <header class="topbar text-white px-4 py-2 d-flex align-items-center gap-3">
    @if (eventName$ | async; as name) {
      <span class="fw-bold fs-5 topbar-title">{{ name }}</span>
    } @else {
      <span class="skeleton-text skeleton-title topbar-title">&nbsp;</span>
    }
    @if (status$ | async; as status) {
      <c-badge
        [color]="status.status === 'Connected' ? 'success'
               : status.status === 'Connecting...' ? 'warning'
               : status.status === 'Error' ? 'danger'
               : 'secondary'"
        [class.pulse-badge]="status.status === 'Connecting...'"
        (click)="onStatusBadgeClick()"
        style="cursor:pointer"
      >{{ status.status }}</c-badge>
    }
    <!-- Show server updates button sits next to connection status -->
    <div class="setting-group">
      <button
        class="btn btn-sm debug-toggle-btn"
        [class.active]="debugVisible"
        (click)="toggleDebug()"
      >Show server updates</button>
      <div class="setting-popover">
        <div class="setting-popover-title">Show server updates</div>
        <div class="setting-popover-body">Opens a live feed of every incoming competitor update from the backend, showing the distance, start number, competitor name, lap number, current lap time and total time. Useful for debugging data flow.</div>
      </div>
    </div>
    @if (hasMassStart$ | async) {
      <div class="d-flex align-items-center gap-2 ms-auto">
        <!-- Section label + separator -->
        <span class="topbar-section-label">Mass Start Settings</span>
        <div class="topbar-section-sep"></div>
        <div class="setting-group">
          <label class="small text-white-50 text-nowrap mb-0 setting-label" for="groupThresholdInput">Max seconds gap between groups</label>
          <input
            id="groupThresholdInput"
            type="number"
            min="0" max="10" step="0.5"
            class="form-control form-control-sm threshold-input"
            [value]="dataService.groupThreshold"
            (change)="onThresholdChange($event)"
          />
          <span class="small text-white-50">s</span>
          <div class="setting-popover">
            <div class="setting-popover-title">Max seconds gap between groups</div>
            <div class="setting-popover-body">Minimum time difference (in seconds) between two competitors <strong>on the same lap</strong> for them to be placed in <strong>separate</strong> standings groups. <br><br>Lower values create more groups; 0 puts every competitor in their own group.<br><br>For comparison: Marathon races maintain a <strong>two second gap</strong> to indicate when a group is formed and which competitors are part of it.</div>
          </div>
        </div>
        <div class="setting-group ms-2">
          <label class="small text-white-50 text-nowrap mb-0 setting-label" for="maxGroupsInput">Max groups</label>
          <input
            id="maxGroupsInput"
            type="number"
            min="0" step="1"
            class="form-control form-control-sm threshold-input"
            [value]="dataService.maxGroups"
            (change)="onMaxGroupsChange($event)"
          />
          <div class="setting-popover">
            <div class="setting-popover-title">Max groups</div>
            <div class="setting-popover-body">Maximum number of standings groups to display in the group strip. Groups are based on the <i>Max seconds gap between groups</i> set to the left. <br><br>Competitors beyond the last group are collected into a "Tail of the race" group. <br><br>Set to 0 to disable grouping entirely.</div>
          </div>
        </div>
        <div class="setting-group ms-2">
          <label class="small text-white-50 text-nowrap mb-0 setting-label" for="lapVarianceInput">Lap Δ</label>
          <input
            id="lapVarianceInput"
            type="number"
            min="0" max="50" step="1"
            class="form-control form-control-sm threshold-input"
            [value]="dataService.lapVarianceThreshold"
            (change)="onLapVarianceChange($event)"
          />
          <span class="small text-white-50">%</span>
          <div class="setting-popover">
            <div class="setting-popover-title">Lap variance threshold</div>
            <div class="setting-popover-body">Percentage difference between <strong>consecutive lap times</strong> used to colour lap badges. <br><br><span class="popover-badge popover-badge-green">green</span> → Within threshold <br><span class="popover-badge popover-badge-orange">orange</span> → Slower than threshold <br><span class="popover-badge popover-badge-purple">purple</span> → Faster than threshold</div>
            <div class="setting-popover-body setting-popover-example">E.g. at 5%: a previous lap of 30.0 s means slower &gt; 31.5 s turns orange, faster &lt; 28.5 s turns purple.</div>
          </div>
        </div>
        <div class="setting-group ms-2">
          <label class="small text-white-50 text-nowrap mb-0 setting-label" for="showLapTimesInput">Lap times</label>
          <input
            id="showLapTimesInput"
            type="checkbox"
            class="form-check-input threshold-checkbox"
            [checked]="dataService.showMassStartLapTimes"
            (change)="onShowLapTimesChange($event)"
          />
          <div class="setting-popover">
            <div class="setting-popover-title">Show lap times</div>
            <div class="setting-popover-body">Show or hide the lap time badge strip on each mass-start competitor row. Hiding lap times gives a cleaner view during busy races.</div>
          </div>
        </div>
      </div>
    }
  </header>
  <!-- ===== ERRORS ===== -->
  <div class="px-4 pt-2">
    @for (error of errors$ | async; track $index; let i = $index) {
      <c-alert color="danger" [dismissible]="true" (visibleChange)="!$event && dataService.dismissError(i)">
        {{ error }}
      </c-alert>
    }
  </div>
  <!-- ===== DEBUG PANEL ===== -->
  @if (debugVisible) {
    @let log = (debugLog$ | async) ?? [];
    <div class="debug-panel px-4 pt-2 pb-2">
      <div class="debug-header d-flex align-items-center gap-2 mb-1">
        <span class="fw-bold small">Server updates</span>
        <span class="text-muted small">({{ log.length }} entries, latest last)</span>
      </div>
      <div class="debug-list">
        @for (entry of log; track $index) {
          <div class="debug-row">
            <span class="debug-ts">{{ formatDebugTime(entry.timestamp) }}</span>
            <span class="debug-dist">{{ entry.distanceName }}</span>
            <span class="debug-num">#{{ entry.startNumber }}</span>
            <span class="debug-name">{{ entry.name }}</span>
            <span class="debug-laps">{{ ordinalSuffix(entry.lapsCount)[0] }}{{ ordinalSuffix(entry.lapsCount)[1] }} lap</span>
            <span class="debug-laptime">{{ entry.currentLapTime || '—' }}</span>
            <span class="debug-time">{{ entry.formattedTotalTime || '—' }}</span>
          </div>
        }
      </div>
    </div>
  }
  <!-- ===== MAIN CONTENT ===== -->
  <main class="flex-grow-1 px-4 pb-4">
    @if ((sortedDistances$ | async)?.length) {
      <c-accordion [alwaysOpen]="true">
        @for (distance of sortedDistances$ | async; track distance.id) {
          <c-accordion-item [visible]="distance.id === initialLiveId"
            [class.accordion-done]="liveEventNumber !== null && distance.eventNumber < liveEventNumber">
            <ng-template cTemplateId="accordionHeader">
              <div class="d-flex w-100 align-items-center gap-2 me-3">
                @if (distance.isLive) {
                  <c-badge color="danger" class="glowing-badge flex-shrink-0">Live</c-badge>
                } @else if (liveEventNumber !== null && distance.eventNumber < liveEventNumber) {
                  <c-badge color="dark" class="flex-shrink-0">Done</c-badge>
                }
                <span class="flex-grow-1 d-flex align-items-center gap-1">
                  {{ distance.name }}
                  @if (distance.isMassStart && distance.totalLaps) {
                    <small class="text-muted">({{ distance.totalLaps }} laps)</small>
                  }
                  @if (!distance.isMassStart && distance.distanceMeters) {
                    <small class="text-muted">({{ distance.distanceMeters }}m)</small>
                  }
                </span>
              </div>
            </ng-template>
            <ng-template cTemplateId="accordionBody">
              <!-- ===== MASS-START TOP STRIP ===== -->
              @if (distance.isMassStart) {
                @let dGroups = (displayedGroups$ | async)?.get(distance.id) ?? [];
                @if (dGroups.length) {
                <div class="groups-strip d-flex flex-row-reverse gap-2 mb-3 pb-1">
                  @for (group of dGroups; track group.groupNumber; let firstGroup = $first) {
                    <div class="group-strip-card flex-shrink-0 {{ groupCardClass($index) }}"
                         [@groupCard]="group.isLastGroup ? 'last' : 'normal'">
                      <c-card class="h-100">
                        <c-card-header class="py-1 px-2">
                          <small class="fw-bold text-nowrap">{{ groupDisplayName(group, firstGroup, distance.anyFinished) }}</small>
                        </c-card-header>
                        <c-card-body class="py-1 px-2">
                          <div [@raceList]="raceListKey(group.races)">
                            @for (race of group.races; track race.id; let firstRace = $first) {
                              <div
                                class="race-item-group d-flex justify-content-between align-items-center rounded px-1 mb-1"
                                [class.flash-update]="isRecentUpdate(race.lastUpdated)"
                                [class.pos-up]="race.position_change === 'up'"
                                [class.pos-down]="race.position_change === 'down'"
                                [class.race-selected]="selectedRaceId === race.id"
                                (click)="selectRace(race.id)"
                              >
                                <div class="d-flex align-items-center gap-1">
                                  <c-badge class="start-num-badge badge-black" style="font-size:0.75em">{{ padStartNumber(race.start_number) }}</c-badge>
                                  <span class="small text-truncate strip-name">{{ race.name }}</span>
                                </div>
                                @if (firstRace) {
                                  @if (!firstGroup && group.gapToGroupAhead) {
                                    <span class="gap-badge text-nowrap">{{ group.gapToGroupAhead }}</span>
                                  } @else if (firstGroup && !distance.anyFinished) {
                                    <c-badge color="success" style="font-size:0.65em">Leader</c-badge>
                                  } @else if (race.is_final_lap) {
                                    <c-badge color="primary" style="font-size:0.65em">Final lap</c-badge>
                                  }
                                } @else {
                                  <span class="text-muted fst-italic ms-1" style="font-size:0.75em;white-space:nowrap">{{ race.gap_to_above }}</span>
                                }
                              </div>
                            }
                          </div>
                        </c-card-body>
                      </c-card>
                    </div>
                  }
                </div>
                } <!-- end @if dGroups.length -->
              } <!-- end @if distance.isMassStart -->
              <c-row>
                <!-- TIMED DISTANCE: one plain unstyled row per heat, competitor cards inside -->
                @if (!distance.isMassStart) {
                  <c-col [xs]="12">
                    @let lapSchedule = distance.distanceMeters ? timedDistanceLapSchedule(distance.distanceMeters) : [];
                    @for (displayGroup of mergedHeatGroups(distance); track displayGroup.label) {
                      <div class="timed-heat-row mb-3">
                        <div class="timed-heat-label">{{ displayGroup.label }}</div>
                        <div class="timed-competitors-row">
                          @for (race of displayGroup.races; track $index) {
                            @if (race) {
                            <div
                                class="timed-competitor-card"
                                [class.flash-update]="isRecentUpdate(race.lastUpdated)"
                                [class.race-finished]="distance.distanceMeters != null && isTimedFinished(race, distance.distanceMeters)"
                                [class.timed-card-purple]="timedCardColor(race) === 'purple'"
                                [class.timed-card-red]="timedCardColor(race) === 'red'"
                                [class.timed-card-orange]="timedCardColor(race) === 'orange'"
                                [attr.data-watermark]="timedWatermarkText(race)"
                              >
                              <!-- Card title: badge + name + status badge left; PB + diff badges right -->
                              <div class="timed-comp-header">
                                <c-badge
                                  class="start-num-badge"
                                  [style.background-color]="race.lane"
                                  [ngClass]="badgeTextClass(race.lane)"
                                >{{ padStartNumber(race.start_number) }}</c-badge>
                                <span class="timed-comp-name">{{ race.name }}</span>
                                @if (race.remark) {
                                  <c-badge [ngClass]="remarkBadgeClass(race.remark)" [title]="timedLabelTitle(race.remark)">{{ race.remark }}</c-badge>
                                }
                                @if (race.invalid_reason) {
                                  <c-badge [ngClass]="invalidBadgeClass(race.invalid_reason)" [title]="timedLabelTitle(race.invalid_reason)">{{ race.invalid_reason }}</c-badge>
                                }
                                @if (race.personal_record) {
                                  <div class="ms-auto d-flex align-items-center gap-1">
                                    @if (distance.distanceMeters) {
                                      @let prComp = timedPrComparison(race, distance.distanceMeters);
                                      @if (prComp) {
                                        <c-badge [color]="prComp.faster ? '' : 'warning'" class="timed-pr-diff-badge" [class.timed-pr-diff-faster]="prComp.faster">{{ prComp.faster ? '-' : '+' }} {{ splitFormattedTime(prComp.diff)[0] }}<small class="time-decimal">{{ splitFormattedTime(prComp.diff)[1] }}</small></c-badge>
                                      }
                                    }
                                    <c-badge class="timed-split-badge">PR: {{ splitFormattedTime(truncateLapTime(race.personal_record, 3))[0] }}<small class="time-decimal">{{ splitFormattedTime(truncateLapTime(race.personal_record, 3))[1] }}</small></c-badge>
                                  </div>
                                }
                              </div>
                              <!-- Card body: one row per lap distance -->
                              <div class="timed-comp-body">
                                @for (lapDist of lapSchedule; track lapDist; let i = $index) {
                                  @let splitTime = timedLapTime(race, i);
                                  @let cumTime = timedCumulativeTime(race, i);
                                  <div class="timed-lap-row" [class.timed-lap-done]="splitTime !== null">
                                    <span class="timed-lap-dist">{{ lapDist }}m</span>
                                    <span class="timed-lap-time-group">
                                      @if (splitTime) {
                                        <!-- Gray split time badge - omit for first lap -->
                                        @if (i > 0) {
                                          <c-badge class="timed-split-badge">{{ splitFormattedTime(truncateLapTime(splitTime, 1))[0] }}<small class="time-decimal">{{ splitFormattedTime(truncateLapTime(splitTime, 1))[1] }}</small></c-badge>
                                        }
                                        <!-- Main cumulative total time (3 decimals) -->
                                        <span class="timed-lap-time">
                                          <span class="race-time">{{ splitFormattedTime(truncateLapTime(cumTime!, 3))[0] }}<small class="time-decimal">{{ splitFormattedTime(truncateLapTime(cumTime!, 3))[1] }}</small></span>
                                        </span>
                                      } @else {
                                        <span class="timed-pending">·</span>
                                      }
                                    </span>
                                  </div>
                                }
                              </div>
                            </div>
                            } @else {
                              <!-- Empty placeholder to preserve lane column position -->
                              <div class="timed-competitor-card timed-lane-placeholder"></div>
                            }
                          }
                        </div>
                      </div>
                    }
                  </c-col>
                }
                <!-- MASS-START: full-width standings -->
                @if (distance.isMassStart) {
                  <c-col [xs]="12">
                    <div [@raceList]="raceListKey(distance.processedRaces)">
                      @for (race of distance.processedRaces; track race.id; let raceIdx = $index) {
                        <!-- Group finishing line above each group's first member -->
                        @if (groupForRace(distance, race.id); as grp) {
                          <div class="group-finishing-line d-flex align-items-center gap-2">
                            <div class="group-line-bar flex-grow-1"></div>
                            <span class="group-sep-count-badge">{{ grp.races.length }}</span>
                            <span class="group-line-label">{{ groupDisplayName(grp, grp.groupNumber === 1, distance.anyFinished) }}</span>
                            @if (grp.gapToGroupAhead) {
                              <span class="group-sep-gap-badge">{{ grp.gapToGroupAhead }}</span>
                            }
                            <div class="group-line-bar flex-grow-1"></div>
                          </div>
                        } @else if (raceIdx > 0 && isFirstInNewGroup(distance, raceIdx)) {
                          <div class="standings-group-gap"></div>
                        }
                        <div
                          class="race-item race-item-laps d-flex align-items-center p-2 mb-1 rounded"
                          [attr.data-race-id]="race.id"
                          [class.flash-update]="isRecentUpdate(race.lastUpdated)"
                          [class.pos-up]="race.position_change === 'up'"
                          [class.pos-down]="race.position_change === 'down'"
                          [class.race-finished]="race.finished_rank != null"
                          [class.race-selected]="selectedRaceId === race.id"
                          (click)="selectRace(race.id)"
                        >
                          <div class="race-item-left d-flex align-items-center gap-2">
                            <span class="rank-label text-muted">{{ ordinalSuffix(raceIdx + 1)[0] }}<sup class="rank-sup">{{ ordinalSuffix(raceIdx + 1)[1] }}</sup></span>
                            <c-badge class="start-num-badge badge-black">{{ padStartNumber(race.start_number) }}</c-badge>
                            <span class="race-name-fixed">{{ race.name }}</span>
                            @if (isRaceLeader(race, distance)) {
                              <c-badge color="success" style="font-size:0.7em">Leader</c-badge>
                            }
                          </div>
                          <!-- Centre column: lap time badges (toggled by setting) always in strip, counter after -->
                          <div class="lap-times-strip">
                            @if (dataService.showMassStartLapTimes) {
                              @for (lt of race.lap_times; track $index; let i = $index; let last = $last; let count = $count) {
                                <span class="lap-time-badge {{ lapBadgeColor(race.lap_times, i) }}"
                                  [class.lap-badge-latest]="last"
                                  [class.lap-badge-prev]="i === count - 2"
                                  [class.lap-badge-old]="i < count - 2"
                                  [attr.data-lap]="last ? race.laps_count : null">
                                  {{ splitLapTime(lt)[0] }}<sup class="lap-time-decimal">{{ (splitLapTime(lt)[1] || '').replace('.', '') }}</sup>
                                </span>
                              }
                              <!-- Pulsing placeholders for pending laps -->
                              @if (distance.totalLaps) {
                                @for (_ of [].constructor(pendingLapCount(race, distance.totalLaps)); track $index; let i = $index) {
                                  <span class="lap-time-badge lap-time-placeholder" [attr.data-pending]="i"> -</span>
                                }
                              }
                            }
                            <!-- Lap counter: plain text, after the badges -->
                            @if (distance.totalLaps) {
                              <span class="laps-counter-text">{{ race.laps_count }}<span class="laps-counter-total">/{{ distance.totalLaps }}</span></span>
                            }
                            <!-- Final lap badge moved here: displayed to the right of the lap counter -->
                            @if (race.is_final_lap) {
                              <c-badge color="primary" class="final-lap-badge">Final lap</c-badge>
                            }
                          </div>
                          <div class="d-flex align-items-center gap-2">
                            @if (race.finished_rank != null) {
                              <span class="mass-finished-label">Finished</span>
                            }
                            @if (race.gap_to_above) {
                              <span class="standings-gap-label">{{ race.gap_to_above }}</span>
                            } @else if (race.formatted_total_time) {
                              <span class="race-time">{{ splitFormattedTime(race.formatted_total_time)[0] }}<small class="time-decimal">{{ splitFormattedTime(race.formatted_total_time)[1] }}</small></span>
                            } @else {
                              <span class="timed-pending">·</span>
                            }
                          </div>
                        </div>
                        <!-- Inline finishing line: rendered below the last lap-completed competitor -->
                        @if (distance.finishingLineAfter && race.id === distance.finishingLineAfter) {
                          <div class="finishing-line d-flex align-items-center gap-2">
                            <div class="finishing-line-bar flex-grow-1"></div>
                            <span class="finishing-line-label">Lap completed</span>
                            <div class="finishing-line-bar flex-grow-1"></div>
                          </div>
                        }
                      }
                    </div>
                  </c-col>
                }
              </c-row>
            </ng-template>
          </c-accordion-item>
        }
      </c-accordion>
    } @else {
      <!-- Skeleton placeholder while connecting -->
      @for (i of [1,2,3]; track i) {
        <div class="skeleton-accordion mb-2 rounded">
          <div class="skeleton-accordion-header d-flex align-items-center gap-3 p-3 rounded">
            <div class="skeleton-block skeleton-title-sm"></div>
            <div class="skeleton-block skeleton-badge"></div>
          </div>
        </div>
      }
    }
  </main>
  <!-- ===== MANAGEMENT POPUP ===== -->
  @if (managementPopupVisible) {
    <div class="management-popup-float">
      <div class="management-popup-window">
        <div class="management-popup-header">
          <span class="fw-bold">Manage Backend Settings</span>
          <button class="btn btn-sm btn-secondary float-end" (click)="closeManagementPopup()">×</button>
        </div>
        <div class="management-popup-body">
          <div class="mb-2">
            <label>Password:</label>
            <input type="password" [(ngModel)]="managementPassword" class="form-control form-control-sm" (change)="fetchManagementStatus()" />
          </div>
          <div class="mb-2">
            <label>Data Source URL:</label>
            <input type="text" [(ngModel)]="managementUrl" class="form-control form-control-sm" />
          </div>
          <div class="mb-2">
            <label>Fetch Interval (seconds):</label>
            <input type="number" [(ngModel)]="managementInterval" class="form-control form-control-sm" min="0.1" step="0.1" />
          </div>
          <div class="mb-2">
            <label>Polling:</label>
            <span class="badge bg-success" *ngIf="managementPolling">Active</span>
            <span class="badge bg-danger" *ngIf="!managementPolling">Stopped</span>
            <button class="btn btn-sm btn-outline-success ms-2" (click)="setPolling('start')" [disabled]="managementPolling">Start</button>
            <button class="btn btn-sm btn-outline-danger ms-2" (click)="setPolling('stop')" [disabled]="!managementPolling">Stop</button>
          </div>
          <div class="mb-2">
            <button class="btn btn-sm btn-primary" (click)="saveManagementSettings()">Save Settings</button>
            <button class="btn btn-sm btn-warning ms-2" (click)="resetManagementData()">Reset Data</button>
          </div>
          <div class="mb-2 text-danger" *ngIf="managementError">{{ managementError }}</div>
          @if ((status$ | async)?.errorMessage; as backendError) {
            <div class="mb-2 text-warning small">{{ backendError }}</div>
          }
        </div>
      </div>
      <div class="management-popup-backdrop" (click)="closeManagementPopup()"></div>
    </div>
  }
</div>
