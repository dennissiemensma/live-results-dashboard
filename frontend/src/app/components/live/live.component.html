@if (eventName$ | async; as name) {
  <div class="d-flex flex-column min-vh-100">
    <!-- Top Bar -->
    <header class="bg-primary text-white p-3 shadow-sm d-flex justify-content-between align-items-center">
      <h3 class="m-0">{{ name }}</h3>
      <div class="d-flex align-items-center gap-3">
        <span class="last-update" [class.pulse]="pulseActive">
          {{ secondsSinceUpdate$ | async }}s ago
        </span>
        <button cButton color="light" variant="outline" size="sm" (click)="dataService.disconnect()">
          Disconnect
        </button>
      </div>
    </header>
    <!-- Main Content -->
    <main class="flex-grow-1 p-4">
      <!-- Dismissable error banners -->
      @for (error of errors$ | async; track $index; let i = $index) {
        <c-alert
          color="danger"
          [dismissible]="true"
          (visibleChange)="$event === false && dataService.dismissError(i)"
        >
          <strong>Error!</strong> {{ error }}
        </c-alert>
      }
      <c-accordion [alwaysOpen]="true">
        @for (distance of sortedDistances$ | async; track distance.id) {
          <c-accordion-item [visible]="distance.id === initialLiveId">
            <ng-template cTemplateId="accordionHeader">
              <div class="d-flex w-100 justify-content-between align-items-center me-3">
                <span>
                  <strong>{{ distance.eventNumber | number: '1.0-0' }}</strong>
                  &nbsp;{{ distance.name }}
                </span>
                @if (distance.isLive) {
                  <c-badge color="danger" class="ms-2 glowing-badge">Live</c-badge>
                }
              </div>
            </ng-template>
            <ng-template cTemplateId="accordionBody">
              <c-row>
                <!-- ======= NON-MASS-START: full-width, grouped by heat ======= -->
                @if (!distance.isMassStart) {
                  <c-col [xs]="12">
                    @for (heatGroup of distance.heatGroups; track heatGroup.heat) {
                      <c-card class="mb-3">
                        <c-card-header class="py-2">
                          <strong>Heat {{ heatGroup.heat }}</strong>
                        </c-card-header>
                        <c-card-body class="py-2 px-3">
                          @for (race of heatGroup.races; track race.id) {
                            <div
                              class="race-item d-flex justify-content-between align-items-center p-2 mb-1 rounded"
                              [class.flash-update]="isRecentUpdate(race.lastUpdated)"
                              [class.pos-up]="race.position_change === 'up'"
                              [class.pos-down]="race.position_change === 'down'"
                            >
                              <div class="d-flex align-items-center gap-2">
                                <c-badge
                                  [style.background-color]="race.lane"
                                  [ngClass]="badgeTextClass(race.lane)" class="start-num-badge"
                                >
                                  {{ padStartNumber(race.start_number) }}
                                </c-badge>
                                <span>{{ race.name }}</span>
                              </div>
                              <div class="d-flex align-items-center gap-2">
                                <c-badge color="secondary">
                                  {{ race.laps_count }} lap{{ race.laps_count !== 1 ? 's' : '' }}
                                </c-badge>
                                @if (race.formatted_total_time && race.formatted_total_time !== 'No Time') {
                                  <span class="race-time">
                                    {{ splitFormattedTime(race.formatted_total_time)[0]
                                    }}<small class="time-decimal">{{
                                      splitFormattedTime(race.formatted_total_time)[1]
                                    }}</small>
                                  </span>
                                } @else {
                                  <span class="text-muted small">No Time</span>
                                }
                              </div>
                            </div>
                          }
                        </c-card-body>
                      </c-card>
                    }
                  </c-col>
                }
                <!-- ======= MASS-START: left column standings + right column groups ======= -->
                @if (distance.isMassStart) {
                  <!-- Left: all races sorted, black lane badges -->
                  <c-col [md]="6" class="border-end">
                    <h6 class="mb-3 fw-bold">Standings</h6>
                    @for (race of distance.processedRaces; track race.id) {
                      <div
                        class="race-item d-flex justify-content-between align-items-center p-2 mb-1 rounded"
                        [class.flash-update]="isRecentUpdate(race.lastUpdated)"
                        [class.pos-up]="race.position_change === 'up'"
                        [class.pos-down]="race.position_change === 'down'"
                      >
                        <div class="d-flex align-items-center gap-2">
                          <c-badge class="badge-black">{{ padStartNumber(race.start_number) }}</c-badge>
                          <span>{{ race.name }}</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                          <c-badge color="secondary">
                            {{ race.laps_count }} lap{{ race.laps_count !== 1 ? 's' : '' }}
                          </c-badge>
                          @if (race.formatted_total_time && race.formatted_total_time !== 'No Time') {
                            <span class="race-time">
                              {{ splitFormattedTime(race.formatted_total_time)[0]
                              }}<small class="time-decimal">{{
                                splitFormattedTime(race.formatted_total_time)[1]
                              }}</small>
                            </span>
                          } @else {
                            <span class="text-muted small">No Time</span>
                          }
                        </div>
                      </div>
                    }
                  </c-col>
                  <!-- Right: groups by laps + time proximity -->
                  <c-col [md]="6">
                    <h6 class="mb-3 fw-bold">Groups</h6>
                    @for (group of distance.standingsGroups; track $index; let first = $first) {
                      @if (!first) {
                        <!-- Inter-group gap separator -->
                        <div class="group-gap-separator d-flex flex-column align-items-center">
                          @if (group.timeBehindLeader) {
                            <c-badge color="warning" class="text-dark">{{ group.timeBehindLeader }}</c-badge>
                          }
                        </div>
                      }
                      <c-card class="mb-2">
                        <c-card-header class="py-1 d-flex justify-content-between align-items-center">
                          <div class="d-flex align-items-center gap-2">
                            <small class="fw-bold">
                              {{ group.laps }} lap{{ group.laps !== 1 ? 's' : '' }}
                            </small>
                            @if (first) {
                              <c-badge color="success">Head of race</c-badge>
                            }
                          </div>
                          @if (group.leaderTime) {
                            <small class="text-muted race-time">
                              {{ splitFormattedTime(group.leaderTime)[0]
                              }}<small class="time-decimal">{{ splitFormattedTime(group.leaderTime)[1] }}</small>
                            </small>
                          }
                        </c-card-header>
                        <c-card-body class="py-2">
                          @for (race of group.races; track race.id; let firstRace = $first) {
                            <div
                              class="race-item-group d-flex justify-content-between align-items-center mb-1 rounded px-1"
                              [class.flash-update]="isRecentUpdate(race.lastUpdated)"
                              [class.pos-up]="race.position_change === 'up'"
                              [class.pos-down]="race.position_change === 'down'"
                            >
                              <div class="d-flex align-items-center gap-2">
                                <c-badge class="badge-black">{{ padStartNumber(race.start_number) }}</c-badge>
                                <span class="small">{{ race.name }}</span>
                              </div>
                              @if (firstRace) {
                                @if (race.formatted_total_time && race.formatted_total_time !== 'No Time') {
                                  <span class="race-time small">
                                    {{ splitFormattedTime(race.formatted_total_time)[0]
                                    }}<small class="time-decimal">{{
                                      splitFormattedTime(race.formatted_total_time)[1]
                                    }}</small>
                                  </span>
                                }
                              } @else {
                                <span class="text-muted small fst-italic">{{ race.gap_to_above }}</span>
                              }
                            </div>
                          }
                        </c-card-body>
                      </c-card>
                    }
                  </c-col>
                }
              </c-row>
            </ng-template>
          </c-accordion-item>
        }
      </c-accordion>
    </main>
  </div>
} @else {
  <div class="d-flex justify-content-center align-items-center min-vh-100 bg-light">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">Waiting for data...</p>
      <button
        cButton
        color="secondary"
        variant="outline"
        size="sm"
        class="mt-3"
        (click)="dataService.disconnect()"
      >
        Cancel
      </button>
    </div>
  </div>
}
